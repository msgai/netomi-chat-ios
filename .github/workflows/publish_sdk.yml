name: Publish SDK to CocoaPods

on:
  push:
    branches:
      - main

jobs:
  publish:
    name: Push Pod to CocoaPods
    runs-on: macos-latest

    outputs:
      version: ${{ steps.version.outputs.VERSION }}

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Setup Ruby + CocoaPods
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.0
          bundler-cache: true

      - name: Install CocoaPods
        run: gem install cocoapods

      - name: Validate Podspec
        run: pod lib lint NetomiChatSDK.podspec --allow-warnings

      - name: Publish to CocoaPods Trunk
        env:
          COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
        run: pod trunk push NetomiChatSDK.podspec --allow-warnings

      - name: Extract SDK Version
        id: version
        run: |
          VERSION=$(grep 's.version' NetomiChatSDK.podspec | sed -E 's/.*"([0-9.]+)".*/\1/')
          echo "VERSION=$VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Create and Push Git Tag
        run: |
          echo "Publishing tag: v${{ steps.version.outputs.VERSION }}"
          git config user.name "Netomi SDK Bot"
          git config user.email "ci@netomi.com"
          git tag "v${{ steps.version.outputs.VERSION }}"
          git push origin "v${{ steps.version.outputs.VERSION }}"

  notify:
    name: Email Notification
    needs: publish
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Send Email Notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: |
            [Netomi iOS SDK] v${{ needs.publish.outputs.version || 'unknown' }} Publish ${{ needs.publish.result == 'success' && 'âœ… Succeeded' || 'âŒ Failed' }}
          to: sandeep.joshi@netomi.com, shruti.aggarwal@netomi.com, mubeen@netomi.com
          from: Netomi iOS SDK CI <sdk-bot@netomi.com>
          body: |
            Hi Team,

            The SDK publish workflow has completed.

            âœ… Status: ${{ needs.publish.result }}
            ğŸ“¦ Version: v${{ needs.publish.outputs.version || 'unknown' }}
            ğŸŒ¿ Branch: ${{ github.ref_name }}
            ğŸ”— Repository: ${{ github.repository }}
            ğŸ”§ Commit: ${{ github.sha }}

            View the full workflow logs here:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            â€” Netomi CI Bot
